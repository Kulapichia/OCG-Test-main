<!DOCTYPE html>
<html>
<head>
    <title>付费检测功能测试</title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>付费检测功能测试</h1>
    <div style="margin-bottom:12px;">
        <button onclick="testPaidDetection()">测试付费检测</button>
        <button onclick="renderSampleUI()">渲染示例UI</button>
    </div>
    <div id="results" style="margin:8px 0 16px;color:#333;"></div>

    <!-- 最小化统计区（含付费统计） -->
    <div class="stats" style="display:flex;gap:16px;margin-bottom:12px;">
        <div class="stat-card"><span class="stat-number" id="totalCount">0</span><span class="stat-label">总数</span></div>
        <div class="stat-card"><span class="stat-number" id="validCount">0</span><span class="stat-label">有效</span></div>
        <div class="stat-card"><span class="stat-number" id="invalidCount">0</span><span class="stat-label">无效</span></div>
        <div class="stat-card"><span class="stat-number" id="rateLimitedCount">0</span><span class="stat-label">限流</span></div>
        <div class="stat-card gemini-only"><span class="stat-number paid" id="paidCount">0</span><span class="stat-label">付费</span></div>
    </div>

    <!-- 仅渲染付费列表容器即可，其它列表可省略 -->
    <div class="tab-content active" id="paidTab">
        <div class="key-list" id="paidKeys" style="border:1px solid #eee;padding:8px;border-radius:6px;"></div>
    </div>

    <script src="js/services/apiUrl.js"></script>
    <script src="js/config/featureFlags.js"></script>
    <script src="js/core/retry.js"></script>
    <script src="js/config/modelOptions.js"></script>
    <script src="js/utils/keys.js"></script>
    <script src="js/utils/clipboard.js"></script>
    <script src="js/i18n/translations.js"></script>
    <script src="js/i18n/i18n.js"></script>
    <script src="js/services/modelsService.js"></script>
    <script src="js/services/openaiService.js"></script>
    <script src="js/services/claudeService.js"></script>
    <script src="js/services/geminiService.js"></script>
    <script src="js/services/geminiPaidService.js"></script>
    <script src="js/services/router.js"></script>
    <!-- UI 渲染逻辑（包含 updateStats / updateKeyLists / showTab） -->
    <script src="js/ui/results.js"></script>

    <script>
        async function testPaidDetection() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>开始测试...</p>';
            
            console.log('功能标志状态:', window.featureFlags);
            console.log('付费检测功能:', window.featureFlags?.paidDetection);
            console.log('testGeminiContextCaching函数:', typeof window.testGeminiContextCaching);
            console.log('testApiKey函数:', typeof window.testApiKey);
            console.log('testGeminiKey函数:', typeof window.testGeminiKey);
            
            // 模拟一个虚拟的测试密钥（不会真实调用API）
            try {
                // 这里不使用真实的密钥，只是测试函数调用链路
                resultsDiv.innerHTML += '<p>✅ 所有必要函数已加载</p>';
                resultsDiv.innerHTML += '<p>✅ 付费检测功能状态: ' + (window.featureFlags?.paidDetection ? '开启' : '关闭') + '</p>';
                resultsDiv.innerHTML += '<p>✅ testGeminiContextCaching函数: ' + (typeof window.testGeminiContextCaching === 'function' ? '可用' : '不可用') + '</p>';
                resultsDiv.innerHTML += '<p>请在控制台查看详细信息</p>';
            } catch (error) {
                resultsDiv.innerHTML += '<p>❌ 测试失败: ' + error.message + '</p>';
                console.error('测试错误:', error);
            }
        }

        // 渲染一个包含付费/有效/无效/限流的示例，以确认 UI 是否正确显示
        function renderSampleUI() {
            // 准备示例数据
            window.currentLang = 'zh';
            window.allKeysData = [
                { key: 'g-paid-xxx', status: 'paid', error: null, type: 'gemini', model: 'gemini-pro', retryCount: 0 },
                { key: 'g-valid-xxx', status: 'valid', error: null, type: 'gemini', model: 'gemini-pro', retryCount: 0 },
                { key: 'g-invalid-xxx', status: 'invalid', error: 'HTTP 401', type: 'gemini', model: 'gemini-pro', retryCount: 0 },
                { key: 'g-rl-xxx', status: 'rate-limited', error: 'Rate Limited (429)', type: 'gemini', model: 'gemini-pro', retryCount: 1 }
            ];

            try { updateStats(); } catch (e) { console.warn('updateStats failed', e); }
            try { updateKeyLists(); } catch (e) { console.warn('updateKeyLists failed', e); }
            try { showTab('paid'); } catch (_) {}

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>已渲染示例数据，请确认：</p>' +
                '<ul>' +
                '<li>付费统计（paidCount）应为 1</li>' +
                '<li>付费列表（paidKeys）中应出现 1 条记录，状态显示“付费”</li>' +
                '</ul>';
        }
    </script>
</body>
</html>
